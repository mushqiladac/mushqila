name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          echo "=========================================="
          echo "Starting Deployment"
          echo "=========================================="
          
          # Navigate to project directory
          cd ~/mushqila || { echo "Directory not found, cloning..."; git clone https://github.com/mushqiladac/mushqila.git ~/mushqila; cd ~/mushqila; }
          
          # Stop containers
          echo "Stopping containers..."
          docker-compose down || true
          
          # Fetch latest code
          echo "Fetching latest code..."
          git fetch origin
          
          # Switch to correct branch
          echo "Switching to branch..."
          git checkout main
          
          # Pull latest changes
          echo "Pulling latest changes..."
          git pull origin main
          
          # Build Docker images
          echo "Building Docker images..."
          docker-compose build
          
          # Start containers
          echo "Starting containers..."
          docker-compose up -d
          
          # Wait for containers to be ready
          echo "Waiting for containers to start..."
          sleep 15
          
          # Run migrations
          echo "Running migrations..."
          docker-compose exec -T web python manage.py migrate
          
          # Collect static files
          echo "Collecting static files..."
          docker-compose exec -T web python manage.py collectstatic --noinput
          
          # Check container status
          echo "Container status:"
          docker-compose ps
          
          echo "=========================================="
          echo "Deployment Complete!"
          echo "=========================================="
