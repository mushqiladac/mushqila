{% extends 'accounts/base.html' %}
{% load i18n %}
{% load static %}
{% load humanize %}

{% block title %}{% trans "Agent Hierarchy" %} | {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">{% trans "Agent Hierarchy" %}</h1>
                    <p class="text-muted mb-0">
                        {% trans "Manage and view your agent network structure" %}
                    </p>
                </div>
                {% if can_add_agent %}
                <a href="#" class="btn btn-primary">
                    <i class="fas fa-plus-circle me-2"></i>{% trans "Add Sub-Agent" %}
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Hierarchy Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                {% trans "Total Agents" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ child_agents.count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                {% trans "Active Agents" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ active_agents }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                {% trans "Total Commission" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ total_commission|floatformat:2|intcomma }} SAR
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-hand-holding-usd fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                {% trans "Avg. Commission" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ avg_commission|floatformat:2|intcomma }}%
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hierarchy Visualization -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-sitemap me-2"></i>{% trans "Hierarchy Structure" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="hierarchy-container" id="hierarchyVisualization">
                        {% if parent_agent %}
                        <div class="hierarchy-level">
                            <!-- Parent Agent -->
                            <div class="hierarchy-node parent">
                                <div class="node-content">
                                    <div class="node-avatar">
                                        <span class="initials">{{ parent_agent.get_full_name|first|upper }}</span>
                                    </div>
                                    <div class="node-info">
                                        <h6 class="mb-1">{{ parent_agent.get_full_name }}</h6>
                                        <p class="text-muted mb-1">{{ parent_agent.email }}</p>
                                        <span class="badge bg-info">{{ parent_agent.get_user_type_display }}</span>
                                    </div>
                                </div>
                                <div class="node-connection"></div>
                            </div>
                            
                            <!-- Current User -->
                            <div class="hierarchy-level">
                                <div class="hierarchy-node current">
                                    <div class="node-connection-up"></div>
                                    <div class="node-content">
                                        <div class="node-avatar">
                                            <span class="initials">{{ user.get_full_name|first|upper }}</span>
                                            <span class="badge bg-primary current-badge">{% trans "You" %}</span>
                                        </div>
                                        <div class="node-info">
                                            <h6 class="mb-1">{{ user.get_full_name }}</h6>
                                            <p class="text-muted mb-1">{{ user.email }}</p>
                                            <span class="badge bg-primary">{{ user.get_user_type_display }}</span>
                                        </div>
                                    </div>
                                    {% if child_agents %}
                                    <div class="node-connection-down"></div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Root Level (Admin or Top-Level Agent) -->
                        <div class="hierarchy-level">
                            <div class="hierarchy-node root">
                                <div class="node-content">
                                    <div class="node-avatar">
                                        <span class="initials">{{ user.get_full_name|first|upper }}</span>
                                        <span class="badge bg-primary current-badge">{% trans "You" %}</span>
                                    </div>
                                    <div class="node-info">
                                        <h6 class="mb-1">{{ user.get_full_name }}</h6>
                                        <p class="text-muted mb-1">{{ user.email }}</p>
                                        <span class="badge bg-primary">{{ user.get_user_type_display }}</span>
                                    </div>
                                </div>
                                {% if child_agents %}
                                <div class="node-connection-down"></div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Child Agents -->
                        {% if child_agents %}
                        <div class="hierarchy-level">
                            <div class="hierarchy-children">
                                {% for agent in child_agents %}
                                <div class="hierarchy-node child" data-agent-id="{{ agent.id }}">
                                    <div class="node-connection-up"></div>
                                    <div class="node-content">
                                        <div class="node-avatar">
                                            <span class="initials">{{ agent.get_full_name|first|upper }}</span>
                                            {% if agent.is_active %}
                                            <span class="status-indicator bg-success"></span>
                                            {% else %}
                                            <span class="status-indicator bg-danger"></span>
                                            {% endif %}
                                        </div>
                                        <div class="node-info">
                                            <h6 class="mb-1">{{ agent.get_full_name }}</h6>
                                            <p class="text-muted mb-1">{{ agent.email }}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-secondary">{{ agent.get_user_type_display }}</span>
                                                <small class="text-success">
                                                    <i class="fas fa-percentage"></i> 
                                                    {% for hierarchy in hierarchies %}
                                                        {% if hierarchy.child_agent == agent %}
                                                            {{ hierarchy.commission_share|floatformat:2 }}%
                                                        {% endif %}
                                                    {% endfor %}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="node-actions">
                                            <button class="btn btn-sm btn-outline-primary view-agent" 
                                                    data-agent-id="{{ agent.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if can_add_agent %}
                                            <button class="btn btn-sm btn-outline-warning edit-hierarchy" 
                                                    data-agent-id="{{ agent.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="node-connection-down"></div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted mb-3">{% trans "No Sub-Agents Found" %}</h5>
                            <p class="text-muted mb-4">
                                {% trans "You don't have any sub-agents in your hierarchy yet." %}
                            </p>
                            {% if can_add_agent %}
                            <a href="#" class="btn btn-primary">
                                <i class="fas fa-plus-circle me-2"></i>{% trans "Add Your First Sub-Agent" %}
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Details Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list me-2"></i>{% trans "Agent Details" %}
                    </h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>{% trans "Export" %}
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportToCSV()">
                                <i class="fas fa-file-csv me-2"></i>{% trans "CSV" %}
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-2"></i>{% trans "PDF" %}
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-2"></i>{% trans "Excel" %}
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    {% if child_agents %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="agentsTable">
                            <thead>
                                <tr>
                                    <th>{% trans "Agent" %}</th>
                                    <th>{% trans "Type" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Commission" %}</th>
                                    <th>{% trans "Total Sales" %}</th>
                                    <th>{% trans "Your Share" %}</th>
                                    <th>{% trans "Join Date" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for agent in child_agents %}
                                <tr data-agent-id="{{ agent.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle-sm me-3">
                                                <span class="initials">{{ agent.get_full_name|first|upper }}</span>
                                            </div>
                                            <div>
                                                <div class="fw-medium">{{ agent.get_full_name }}</div>
                                                <small class="text-muted">{{ agent.email }}</small>
                                                <br>
                                                <small class="text-muted">{{ agent.phone }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ agent.get_user_type_display }}</span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if agent.status == 'active' %}bg-success
                                            {% elif agent.status == 'inactive' %}bg-secondary
                                            {% elif agent.status == 'suspended' %}bg-danger
                                            {% elif agent.status == 'pending' %}bg-warning
                                            {% else %}bg-light text-dark{% endif %}">
                                            {% if agent.status == 'active' %}
                                            <i class="fas fa-check-circle me-1"></i>
                                            {% elif agent.status == 'suspended' %}
                                            <i class="fas fa-ban me-1"></i>
                                            {% elif agent.status == 'pending' %}
                                            <i class="fas fa-clock me-1"></i>
                                            {% endif %}
                                            {{ agent.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% for hierarchy in hierarchies %}
                                            {% if hierarchy.child_agent == agent %}
                                                <div class="text-center">
                                                    <div class="h6 mb-0">{{ hierarchy.commission_share|floatformat:2 }}%</div>
                                                    <small class="text-muted">{% trans "Commission Rate" %}</small>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <div class="text-end">
                                            <div class="h6 mb-0">{{ agent.profile.total_sales|default:0|floatformat:2|intcomma }} SAR</div>
                                            <small class="text-muted">
                                                {{ agent.profile.total_bookings|default:0 }} {% trans "bookings" %}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-end">
                                            {% for hierarchy in hierarchies %}
                                                {% if hierarchy.child_agent == agent %}
                                                    {% with sales=agent.profile.total_sales|default:0 share=hierarchy.commission_share %}
                                                    <div class="h6 mb-0 text-success" 
                                                         data-sales="{{ sales }}" 
                                                         data-share="{{ share }}">
                                                        {{ sales }} SAR ({{ share }}%)
                                                    </div>
                                                    {% endwith %}
                                                {% endif %}
                                            {% endfor %}
                                            <small class="text-muted">{% trans "Your commission" %}</small>
                                        </div>
                                    </td>
                                    <td>
                                        {% for hierarchy in hierarchies %}
                                            {% if hierarchy.child_agent == agent %}
                                                {{ hierarchy.created_at|date:"d M Y" }}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" 
                                                    class="btn btn-outline-primary view-agent-details" 
                                                    data-agent-id="{{ agent.id }}"
                                                    title="{% trans 'View Details' %}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if can_add_agent %}
                                            <button type="button" 
                                                    class="btn btn-outline-warning edit-commission" 
                                                    data-agent-id="{{ agent.id }}"
                                                    data-current-commission="
                                                        {% for hierarchy in hierarchies %}
                                                            {% if hierarchy.child_agent == agent %}
                                                                {{ hierarchy.commission_share }}
                                                            {% endif %}
                                                        {% endfor %}"
                                                    title="{% trans 'Edit Commission' %}">
                                                <i class="fas fa-percentage"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-outline-info send-message" 
                                                    data-agent-id="{{ agent.id }}"
                                                    title="{% trans 'Send Message' %}">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                            {% endif %}
                                            <a href="{% url 'agent_transactions' agent.id %}" 
                                               class="btn btn-outline-success" 
                                               title="{% trans 'View Transactions' %}">
                                                <i class="fas fa-exchange-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Commission Summary -->
    <div class="row mt-4">
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-pie me-2"></i>{% trans "Commission Distribution" %}
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="commissionChart" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-line me-2"></i>{% trans "Performance Trend" %}
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Detail Modal -->
<div class="modal fade" id="agentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Agent Details" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="agentDetailContent">
                <!-- Content loaded via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Close" %}
                </button>
                <button type="button" class="btn btn-primary" id="contactAgent">
                    <i class="fas fa-phone me-2"></i>{% trans "Contact Agent" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Commission Modal -->
<div class="modal fade" id="editCommissionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary">
                    <i class="fas fa-percentage me-2"></i>{% trans "Edit Commission Rate" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="commissionForm">
                    {% csrf_token %}
                    <input type="hidden" id="agentId" name="agent_id">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Agent Name" %}</label>
                        <input type="text" class="form-control" id="agentName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Current Commission Rate" %} (%)</label>
                        <input type="text" class="form-control" id="currentCommission" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "New Commission Rate" %} (%) *</label>
                        <input type="number" 
                               class="form-control" 
                               id="newCommission" 
                               name="commission_rate"
                               min="0" 
                               max="50" 
                               step="0.01"
                               required>
                        <small class="form-text text-muted">
                            {% trans "Enter new commission rate between 0% and 50%" %}
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Reason for Change" %}</label>
                        <textarea class="form-control" 
                                  id="changeReason" 
                                  name="reason"
                                  rows="3" 
                                  placeholder="{% trans 'Explain the reason for changing commission rate...' %}"
                                  required></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        {% trans "This change will apply to all future transactions. Existing commissions will not be affected." %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    {% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-primary" id="saveCommission">
                    {% trans "Save Changes" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary">
                    <i class="fas fa-envelope me-2"></i>{% trans "Send Message to Agent" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    {% csrf_token %}
                    <input type="hidden" id="messageAgentId" name="agent_id">
                    <div class="mb-3">
                        <label class="form-label">{% trans "To" %}</label>
                        <input type="text" class="form-control" id="messageAgentName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Subject" %} *</label>
                        <input type="text" 
                               class="form-control" 
                               id="messageSubject" 
                               name="subject"
                               required
                               placeholder="{% trans 'Enter message subject...' %}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Message" %} *</label>
                        <textarea class="form-control" 
                                  id="messageContent" 
                                  name="content"
                                  rows="5" 
                                  required
                                  placeholder="{% trans 'Type your message here...' %}"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendEmailCopy" name="send_email">
                            <label class="form-check-label" for="sendEmailCopy">
                                {% trans "Send email copy to agent" %}
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    {% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-primary" id="sendMessageBtn">
                    {% trans "Send Message" %}
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate commission amounts with JavaScript
        document.querySelectorAll('[data-sales]').forEach(element => {
            const sales = parseFloat(element.getAttribute('data-sales'));
            const share = parseFloat(element.getAttribute('data-share'));
            const commission = (sales * share) / 100;
            if (!isNaN(commission)) {
                element.textContent = commission.toFixed(2) + ' SAR';
            }
        });

        // Modal instances
        const agentDetailModal = new bootstrap.Modal(document.getElementById('agentDetailModal'));
        const editCommissionModal = new bootstrap.Modal(document.getElementById('editCommissionModal'));
        const sendMessageModal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
        
        let currentAgentId = null;
        
        // View Agent Details
        document.querySelectorAll('.view-agent, .view-agent-details').forEach(button => {
            button.addEventListener('click', function() {
                currentAgentId = this.getAttribute('data-agent-id');
                loadAgentDetails(currentAgentId);
            });
        });
        
        // Edit Commission
        document.querySelectorAll('.edit-commission').forEach(button => {
            button.addEventListener('click', function() {
                currentAgentId = this.getAttribute('data-agent-id');
                const currentCommission = this.getAttribute('data-current-commission');
                const agentRow = document.querySelector(`tr[data-agent-id="${currentAgentId}"]`);
                const agentName = agentRow.querySelector('.fw-medium').textContent;
                
                document.getElementById('agentId').value = currentAgentId;
                document.getElementById('agentName').value = agentName;
                document.getElementById('currentCommission').value = currentCommission + '%';
                document.getElementById('newCommission').value = currentCommission;
                
                editCommissionModal.show();
            });
        });
        
        // Send Message
        document.querySelectorAll('.send-message').forEach(button => {
            button.addEventListener('click', function() {
                currentAgentId = this.getAttribute('data-agent-id');
                const agentRow = document.querySelector(`tr[data-agent-id="${currentAgentId}"]`);
                const agentName = agentRow.querySelector('.fw-medium').textContent;
                
                document.getElementById('messageAgentId').value = currentAgentId;
                document.getElementById('messageAgentName').value = agentName;
                
                sendMessageModal.show();
            });
        });
        
        // Save Commission
        document.getElementById('saveCommission').addEventListener('click', function() {
            saveCommission();
        });
        
        // Send Message
        document.getElementById('sendMessageBtn').addEventListener('click', function() {
            sendMessage();
        });
        
        // Contact Agent
        document.getElementById('contactAgent').addEventListener('click', function() {
            if (currentAgentId) {
                const agentRow = document.querySelector(`tr[data-agent-id="${currentAgentId}"]`);
                const phone = agentRow.querySelector('small.text-muted').nextSibling.nextSibling.textContent.trim();
                window.location.href = `tel:${phone}`;
            }
        });
        
        // Load agent details via AJAX
        function loadAgentDetails(agentId) {
            const contentDiv = document.getElementById('agentDetailContent');
            contentDiv.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                    <p class="mt-3">{% trans "Loading agent details..." %}</p>
                </div>
            `;
            
            agentDetailModal.show();
            
            fetch(`/api/agent/${agentId}/details/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        contentDiv.innerHTML = formatAgentDetails(data.agent);
                    } else {
                        contentDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    contentDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {% trans "Error loading agent details. Please try again." %}
                        </div>
                    `;
                });
        }
        
        function formatAgentDetails(agent) {
            return `
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-4">
                            <div class="avatar-circle-lg mx-auto mb-3">
                                <span class="initials">${agent.full_name[0].toUpperCase()}</span>
                            </div>
                            <h4>${agent.full_name}</h4>
                            <p class="text-muted mb-1">${agent.email}</p>
                            <p class="text-muted mb-3">${agent.phone}</p>
                            <span class="badge bg-${getStatusColor(agent.status)} mb-2">
                                ${agent.status_display}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h5 class="mb-3">{% trans "Agent Information" %}</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted">{% trans "User Type" %}</label>
                                <div class="form-control bg-light">${agent.user_type_display}</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted">{% trans "Company" %}</label>
                                <div class="form-control bg-light">${agent.company_name || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted">{% trans "Commission Rate" %}</label>
                                <div class="form-control bg-light">${agent.commission_rate}%</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted">{% trans "Credit Limit" %}</label>
                                <div class="form-control bg-light">${agent.credit_limit} SAR</div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label text-muted">{% trans "Address" %}</label>
                                <div class="form-control bg-light" style="min-height: 60px;">
                                    ${agent.address || 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mb-3">{% trans "Performance Statistics" %}</h5>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <div class="h4 text-primary">${agent.total_bookings || 0}</div>
                                        <small class="text-muted">{% trans "Total Bookings" %}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <div class="h4 text-success">${agent.total_sales || 0} SAR</div>
                                        <small class="text-muted">{% trans "Total Sales" %}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card border-info">
                                    <div class="card-body text-center">
                                        <div class="h4 text-info">${agent.total_commission || 0} SAR</div>
                                        <small class="text-muted">{% trans "Total Commission" %}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <div class="h4 text-warning">${agent.hajj_bookings || 0}</div>
                                        <small class="text-muted">{% trans "Hajj Bookings" %}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>{% trans "Member Since:" %}</strong> ${agent.join_date}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'active': return 'success';
                case 'inactive': return 'secondary';
                case 'suspended': return 'danger';
                case 'pending': return 'warning';
                default: return 'light';
            }
        }
        
        function saveCommission() {
            const form = document.getElementById('commissionForm');
            const formData = new FormData(form);
            
            fetch('/api/agent/commission/update/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                editCommissionModal.hide();
                if (data.success) {
                    showToast('{% trans "Commission rate updated successfully" %}', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || '{% trans "Error updating commission rate" %}', 'danger');
                }
            })
            .catch(error => {
                editCommissionModal.hide();
                showToast('{% trans "Error updating commission rate" %}', 'danger');
            });
        }
        
        function sendMessage() {
            const form = document.getElementById('messageForm');
            const formData = new FormData(form);
            
            fetch('/api/agent/message/send/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                sendMessageModal.hide();
                if (data.success) {
                    showToast('{% trans "Message sent successfully" %}', 'success');
                } else {
                    showToast(data.error || '{% trans "Error sending message" %}', 'danger');
                }
            })
            .catch(error => {
                sendMessageModal.hide();
                showToast('{% trans "Error sending message" %}', 'danger');
            });
        }
        
        // Export functions
        window.exportToCSV = function() {
            showToast('{% trans "Exporting to CSV..." %}', 'info');
            // In production, implement actual CSV export
            setTimeout(() => {
                showToast('{% trans "CSV export started" %}', 'success');
            }, 1000);
        };
        
        window.exportToPDF = function() {
            showToast('{% trans "Generating PDF..." %}', 'info');
            // In production, implement actual PDF export
            setTimeout(() => {
                showToast('{% trans "PDF generated successfully" %}', 'success');
            }, 1500);
        };
        
        window.exportToExcel = function() {
            showToast('{% trans "Exporting to Excel..." %}', 'info');
            // In production, implement actual Excel export
            setTimeout(() => {
                showToast('{% trans "Excel export started" %}', 'success');
            }, 1000);
        };
        
        // Initialize charts
        initializeCharts();
        
        function initializeCharts() {
            // Commission Distribution Chart
            const commissionCtx = document.getElementById('commissionChart').getContext('2d');
            const commissionChart = new Chart(commissionCtx, {
                type: 'doughnut',
                data: {
                    labels: [
                        '{% trans "Agent 1" %}',
                        '{% trans "Agent 2" %}',
                        '{% trans "Agent 3" %}',
                        '{% trans "Agent 4" %}',
                        '{% trans "Other Agents" %}'
                    ],
                    datasets: [{
                        data: [35, 25, 20, 10, 10],
                        backgroundColor: [
                            '#4e73df',
                            '#1cc88a',
                            '#36b9cc',
                            '#f6c23e',
                            '#858796'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Performance Trend Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            const performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: [
                        '{% trans "Jan" %}', '{% trans "Feb" %}', '{% trans "Mar" %}', 
                        '{% trans "Apr" %}', '{% trans "May" %}', '{% trans "Jun" %}'
                    ],
                    datasets: [{
                        label: '{% trans "Sales (SAR)" %}',
                        data: [150000, 180000, 220000, 190000, 250000, 300000],
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: '{% trans "Commission (SAR)" %}',
                        data: [15000, 18000, 22000, 19000, 25000, 30000],
                        borderColor: '#1cc88a',
                        backgroundColor: 'rgba(28, 200, 138, 0.05)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' SAR';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toast);
            });
        }
    });
</script>

<style>
    .card {
        border-radius: 10px;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }
    
    /* Hierarchy Visualization Styles */
    .hierarchy-container {
        min-height: 300px;
        position: relative;
    }
    
    .hierarchy-level {
        display: flex;
        justify-content: center;
        margin: 20px 0;
        position: relative;
    }
    
    .hierarchy-children {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
    }
    
    .hierarchy-node {
        position: relative;
        text-align: center;
        padding: 10px;
        min-width: 200px;
    }
    
    .hierarchy-node.root,
    .hierarchy-node.parent,
    .hierarchy-node.current {
        margin: 0 auto;
    }
    
    .node-content {
        background: white;
        border: 2px solid #4e73df;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
    }
    
    .hierarchy-node.child .node-content {
        border-color: #1cc88a;
    }
    
    .hierarchy-node.parent .node-content {
        border-color: #36b9cc;
    }
    
    .hierarchy-node.current .node-content {
        border-color: #f6c23e;
        box-shadow: 0 6px 12px rgba(246, 194, 62, 0.2);
    }
    
    .node-content:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }
    
    .node-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 24px;
        font-weight: bold;
        position: relative;
    }
    
    .hierarchy-node.child .node-avatar {
        background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
    }
    
    .hierarchy-node.parent .node-avatar {
        background: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
    }
    
    .hierarchy-node.current .node-avatar {
        background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
    }
    
    .current-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 10px;
        padding: 2px 6px;
    }
    
    .status-indicator {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
    }
    
    .node-info h6 {
        font-size: 14px;
        margin-bottom: 5px;
    }
    
    .node-info p {
        font-size: 12px;
        margin-bottom: 5px;
    }
    
    .node-actions {
        margin-top: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .node-content:hover .node-actions {
        opacity: 1;
    }
    
    .node-actions .btn {
        margin: 0 2px;
        padding: 2px 8px;
        font-size: 12px;
    }
    
    /* Connection Lines */
    .node-connection {
        position: absolute;
        width: 2px;
        background: #dee2e6;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .node-connection-up {
        height: 20px;
        top: -20px;
    }
    
    .node-connection-down {
        height: 20px;
        bottom: -20px;
    }
    
    .hierarchy-node:not(:last-child) .node-connection-down {
        height: 40px;
    }
    
    .hierarchy-node.parent .node-connection {
        height: 50px;
        bottom: -50px;
    }
    
    .hierarchy-node.current .node-connection-up {
        height: 50px;
        top: -50px;
    }
    
    /* Table Styles */
    .table th {
        font-weight: 600;
        color: #495057;
        background-color: #f8f9fa;
        border-top: none;
    }
    
    .badge {
        font-weight: 500;
        padding: 5px 10px;
        border-radius: 20px;
    }
    
    .avatar-circle-sm {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #4e73df;
        color: white;
        display: flex;
        align-items-center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }
    
    .avatar-circle-lg {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 36px;
    }
    
    .btn-group .btn {
        border-radius: 4px;
    }
    
    .dropdown-menu {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .dropdown-item {
        border-radius: 4px;
        margin: 2px 5px;
        width: calc(100% - 10px);
    }
    
    .toast {
        z-index: 1060;
    }
    
    @media (max-width: 768px) {
        .h3, .h5, .h6 {
            font-size: 1rem;
        }
        
        .hierarchy-children {
            flex-direction: column;
            align-items: center;
        }
        
        .hierarchy-node {
            min-width: 250px;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .btn-group .btn {
            padding: 0.25rem 0.5rem;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 3px 6px;
        }
        
        .avatar-circle-sm {
            width: 24px;
            height: 24px;
            font-size: 12px;
        }
        
        .avatar-circle-lg {
            width: 80px;
            height: 80px;
            font-size: 28px;
        }
    }
    
    @media (max-width: 576px) {
        .hierarchy-node {
            min-width: 200px;
        }
        
        .node-content {
            padding: 10px;
        }
        
        .node-avatar {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        
        .node-info h6 {
            font-size: 12px;
        }
        
        .node-info p {
            font-size: 10px;
        }
    }
</style>
{% endblock %}